<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script language="JavaScript" src="jquery.js"></script>
    <script language="JavaScript" src="go-debug.js"></script>
	<script src="http://demo.qunee.com/lib/qunee-min.js"></script>
</head>
<body>
    <div id="canvas" style="width:1000px; height:600px; background-color: #DAE4E4;"></div>
    <div id="diagramEventsMsg" style="width:400px; height:150px; background-color: #A1F514; margin-top: 50px"></div>
    <input type="file" name="upload" id="upload"/>
	<select id="protocol">
        <option value="1">ACL</option>
        <option value="2">xxx</option>
        <option value="3">xxx</option>
        <option value="4">xxx</option>
    </select>
    <button onclick="uploadfile()">执行</button>
	<button onclick="uploadfile()">清空配置</button>
    <p name="content" id="content"></p>

<script>
    // 显示文件内容
    window.onload = function() {
        var getFileContent = function (fileInput, callback) {
            if (fileInput.files && fileInput.files.length > 0 && fileInput.files[0].size > 0) {
                //下面这一句相当于JQuery的：var file =$("#upload").prop('files')[0];
                var file = fileInput.files[0];
                if (window.FileReader) {
                    var reader = new FileReader();
                    reader.onloadend = function (evt) {
                        if (evt.target.readyState == FileReader.DONE) {
                            callback(evt.target.result);
                        }
                    };
                    // 包含中文内容用gbk编码
                    reader.readAsText(file, 'utf-8');
                }
            }
        };
        /**
         * upload内容变化时载入内容
         */
        document.getElementById('upload').onchange = function () {
            var content = document.getElementById('content');
            getFileContent(this, function (str) {
				console.log("get success");
				requestBody = str;
				var link = JSON.parse(str)["links"][0]
				var route = JSON.parse(str)["routes"][0]
                //console.log(link);
                //console.log(route);
				str=str.replace(/\n/g,"<br/>"); //格式保留，追加换行
                content.innerHTML = str;
                var routes = [];
                for(var key in route){
                    routes.push(route[key])
                };
                var links = [];
                for(var key in link){
                    links.push(link[key])
                };
				console.log(routes)
				console.log(links)
                draw_pic(routes,links);
            });
        };
    };

    function uploadfile(){
        var data = document.getElementById('content').value;
        var httpRequest = new XMLHttpRequest();//第一步：建立所需的对象
        httpRequest.open("POST", "/AddDataToServer", true);  //调用AddDataToServer
        httpRequest.setRequestHeader("Content-Type", "application/json");   //设置请求头信息
		//body = requestBody;
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                alert('添加成功');
            }
        }
		//console.log(data);
		var protocol = document.getElementById("protocol");
		var index = protocol.selectedIndex ;
		console.log(protocol.options[index].text);
        httpRequest.send(JSON.stringify(data)); //设置为发送给服务器数据
    };
	
	function resetAll(){
		
	};
    // 绘制拓扑图
    function draw_pic(routes, lines){
		var graph = new Q.Graph('canvas');
		var map = {};
        if(routes){
			var t = 50;
			for(var i = 0;i < routes.length;i++)
			{
				var node = graph.createNode(routes[i].name);
                node.set("data", routes[i]);
				if(routes[i].type == "router")
				{
					node.image = "Q-exchanger2";
					switch(routes[i].key)
					{
						case "A":
							node.location = new Q.Point(-100,50);
							break;
						case "B":
							node.location = new Q.Point(-300,200);
							break;
						case "C":
							node.location = new Q.Point(100,200);
							break;
						default:
							node.location = new Q.Point(-100,100);
					}
				}
					
				if(routes[i].type == "switch")
				{
					node.image = "Q-exchanger";
					node.location = new Q.Point(-100,-100);
				}
                map[routes[i].key] = node;
			}

        }
        if(lines){
            Q.forEach(lines, function(data){
                var from = map[data.from];
                var to = map[data.to];
				//console.log("from:"+from.key)
                if(!from || !to){
                    return;
                }
                var edge = graph.createEdge(data.name, from, to);
				edge.setStyle(Q.Styles.ARROW_TO, false);
                edge.set("data", data);
				var labelFrom = new Q.LabelUI();
				labelFrom.position = Q.Position.LEFT_TOP;
				labelFrom.anchorPosition = Q.Position.LEFT_BOTTOM;
				labelFrom.border = 1;
				labelFrom.padding = new Q.Insets(2, 5);
				labelFrom.showPointer = true;
				labelFrom.offsetY = -30;
				labelFrom.backgroundColor = "#EEE";
				labelFrom.fontSize = 10;
				labelFrom.fontStyle = "italic 100";
				edge.addUI(labelFrom, [{
					property : "labelFrom",
					propertyType : Q.Consts.PROPERTY_TYPE_CLIENT,
					bindingProperty : "data"
				}, {
					property : "labelFrom.color",
					propertyType : Q.Consts.PROPERTY_TYPE_CLIENT,
					bindingProperty : "color"
				}]);
				if(data.FromIp)
					edge.set("labelFrom", data.FromNet+":" + data.FromIp);
				
				//console.log(data.from);
				if(map[data.from].image != "Q-exchanger")
				{
					var labelTo = new Q.LabelUI();
					labelTo.position = Q.Position.RIGHT_BOTTOM;
					labelTo.anchorPosition = Q.Position.RIGHT_BOTTOM;
					labelTo.border = 1;
					labelTo.padding = new Q.Insets(2, 5);
					labelTo.showPointer = true;
					labelTo.offsetY = 50;
					labelTo.backgroundColor = "#EEE";
					labelTo.fontSize = 10;
					labelTo.fontStyle = "italic 100";
					edge.addUI(labelTo, [{
						property : "labelTo",
						propertyType : Q.Consts.PROPERTY_TYPE_CLIENT,
						bindingProperty : "data"
					}, {
						property : "labelTo.color",
						propertyType : Q.Consts.PROPERTY_TYPE_CLIENT,
						bindingProperty : "color"
					}]);
					
					if(data.ToIp)
						edge.set("labelTo", data.ToNet + ":" + data.ToIp);
				}
				
            }, graph);
			
        }
		//var layouter = new Q.SpringLayouter(graph);
		//layouter.start();
		/*var layouter = new Q.TreeLayouter(graph);
		layouter.parentChildrenDirection = Q.Consts.DIRECTION_BOTTOM;
		layouter.layoutType = Q.Consts.LAYOUT_TYPE_TWO_SIDE;
		layouter.doLayout({callback: function(){
			graph.zoomToOverview();
		}});*/
	}
/*        var GO = go.GraphObject.make;
        var myDiagram =
            GO(go.Diagram, "myDiagramDiv3",
              {
                "undoManager.isEnabled": true // enable Ctrl-Z to undo and Ctrl-Y to redo,
            });
        // define a simple Node template
        myDiagram.nodeTemplate =
            GO(go.Node, "Horizontal",
              { background: "#44CCFF" },
              GO(go.Picture,
                { margin: 10, width: 50, height: 50, background: "red" },
                new go.Binding("source")),
              GO(go.TextBlock,
                "Default Text",  // the initial value for TextBlock.text
                { margin: 12, stroke: "white", font: "bold 16px sans-serif" },
                new go.Binding("text", "name"))
             );
        var model = GO(go.GraphLinksModel);
        model.nodeDataArray =routes;
        model.linkDataArray = lines;
        myDiagram.model = model;

        function showMessage(s){
            document.getElementById("diagramEventsMsg").innerHTML = s
        }

        myDiagram.addDiagramListener("ObjectSingleClicked",
            function (e){
                console.log("clickEvent triggered")
                var part = e.subject.part;
                //if (!(part instanceof go.Link)){
                console.log(part.data)
                showMessage(part.data.key)
            }
        )*/
    

</script>

</body>
</html>